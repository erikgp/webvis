2025-11-21:
- 'use strict' everywher.
- some changes sec to above
- let => const in some places (även om var är betydligt snabbare än både let och const, låter även en del vara kvar let även om de kan vara const)

2025-11-18:
- prot.js: - ska inte kunna ändra konc om ingen konc är angiven - detta för att minska risk för missförstånd att man kan "sätter" kontrasttyp innan ett protokoll är valt

2025-11-18:
- bump av programversion: 0.6.3
- la till snabbknappar för omnipaque- och visipaque-konc. (sköterskeförslag)
- kontrast.html:
  - förändringar för att få med ovan
  - tagit bort vikt och längd ur taborder för protokoll-delen
- prot.js:
  - lagt till funktion för snabbändring av konc
- protokoll_funcs.js
  - använde ceil och floor för att bestämma volymerna (för att alltid lägga lite mer på inj med mindre mängd kontrast.)
    Gått över till avrundning då sköterskorna inte tycker att det stämmer (notera att kan bli fel om det råkar bli x.5 på båda eftersom Math.round då alltid avrundar uppåt)
- style.css:
  - ändringar för kontrastknapparna

2025-11-17:
- bump av programversion: 0.6.2
- updat protokoll till senaste versionen

2025-11-16:
- prot.js:
  - fixed bug where invalid values in protokoll_data.js could result in inconsistent values in the protocol
  - some cleanup

2025-11-15:
- bump av programversion: 0.6.1
- prot.js: changed to Math.min in one place. Clearar.
- protokoll_data.js, protokoll_funcs.js:
  - protokollspecifika parametrar.
    Lagt till möjligheten att lägga till protokollspecifika parametrar i protokoll_data.js.
    Egentligen fanns redan denna möjlighet med tydliggjort att det går att göra.
    På detta sätt finns nu ett generellt sätt att ange parametrar för 2 injektioner.
  - Ändrat något i koden för 2 injektioner

2025-11-15_3
- prot.js
  - fixat bugg när protokollspecifika funktioner kallas. Det behöver inte finnas något aktuellt protokoll och detta måste kontrolleras innan
    kontollen av om det aktuella protokollet har någon protokollspecifik funktion.
- kontrast.html
  - tagit bort text för att förenkla utseende.

2025-11-15_2
- bump av programversion: 0.6.0
- Lagt till protokollspecifika funktioner. Kan nu beräkna och visa speciell data för ett protokoll
- kontrast.html
  - lagt till div för info från protokollspecifika funktioner
- prot.js
  - lagt till kod för att kalla protokollspecifika funktioner. Se kod för signatur för dessa funktioner.
  - lagt till kod för att rensa protokollspecifik info
  - inj.hast och dos (g I) nu med 1 decimal. Överdrivet med 2 decimaler.
- protokoll_data.js
  - tagit bort kommentar för protokoll_data_lates för att demonstrera utseende om protkollet är gammalt
  - lagt till protokollspecifik funktion till vissa protokoll
- style.css
  - lagt till style för div för data från protkollspecifika funktioner
- lagt till protokoll_funcs.js som innehåller protokollspecifika funktioner

2025-11-15
- prot.js:
  - added exact values to pd form (attribut data-exactval) for bmi, agfr and rgfr (for use with protocol specific functions)
  - fixed bug when resetting of pd form in prot_pdfrom_populate
  - prot_rensa_allt now clears pd form as well
  - filtering protocols does not clear pd form (split prot_rensa_allt into 2 functions - one that clears protocol, injection parameters etc, and one that calls the other
    after clearing pd form as well)

2025-11-14_3
- bump av programversion: 0.5.11
- samma ordning mellan agfr och rgfr överallt (agfr först, eftersom det är vi mest intresserade av)
- bytt namn från comment => tags för protokollmedlem som tidigare hette comment, men som användes för tags

2025-11-14_2
- Updaterade kommenterar i de flesta filer
- gfr.js
  - mindre förenkling i gfr_submit_gfr_form
  - bytt el.checkValidity() mot el.validity.valid  där el är ett input-element
    checkValidity() fyrar ett invalid event om input-elementet inte är valid. validity.valid returnerar enbart om element är valid eller ej.
    Notera att validity.valid inte verkar kunna användas för hela forms, utan enbart per input element.
  - prot_populate_protparams beräknade beräknade readonly-värden i pf form. Detta sker dock också vid for submission, så onödigt.


2025-11-14
- bump av programversion: 0.5.10
- main.js:
   js toFixed() does not only round to the given number of decimals, it also converts the number into a string.
   This could result in hard to find bugs (ex "40" < "5"  ==> true). For this reason a function tofixed, 
   which rounds a numer to a given number of decimals, is implemented and used.
- gfr.js: 
    - updated res global. Added more "calculated" vars to the global (for possible use in protocol specific function).
      The calculated_* members are otherwise only used when populating the pd form
    - Added up2date to res for possible use in protocol specific function. This memeber should be true when data in the gfr form is consistent
      with data in the res global, but false otherwise (ie set to false on change events in the gfr form or when the gfr form is cleared)
    - Added bmi_s and ky_s, for string versions of bmi and ky, in res. See reason for this above.
      Since rgfr and agfr is integers such string versions are not added - a bit inconsistent..
    - The calculated_* members are now only used to signal if the data internal to the
      res object is consistent. For example calculated_gfr indicates that the agfr and rgfr values are
      consistent with the age, vikt, langd, and kreatinin values) 
    - Updated code to use string versions (of above) in displayed text and copyable text
    - updated code otherwise in gfr.js to reflect the changes desc. above for the res global
    - Updated the gfr_change function, gfr_resetgfrdata function.
      There was no clear sep of resp in above. Now better.
- kontrast.html:
    - all input elements in the pd form set to readonly
- prot.js:
    - some changes to prot_pdform_populate sec to changing the res global
    - added a prot_reset_pd_form function (to be called from gfr.js if we want to reset the pd forms for example
      when clearing the gfr forms och on change events in the gfr form. This is currently not used (see below))
- style.js:
    - Added possibility to have the pd form hidden

- Status of the pd form.
  We can essentially use the pd form in 4 different ways:
  a. Completely read only and visible, as per this commit.
     Data from the GFR from is transferred to the pd form on submit of the gfr form (when all data in the res global is also updated),
     but the pd form is not otherwise changed from the gfr part of the code (for example it is not changed on change or reset of the gfr form).
     ==> it is clear what data is used in the protocol forms. The data in the res global is conistent with the data in the pd form, even on changes in the gfr form,
         the data in the gfr from may NOT show the same value as the data in the pd form.
  b. Completely read only and hidded (all code for this is implementet if this is desired) but cleared on change events in the gfr form
     (There is css for this already in place - see style.css)
     ==> It is not as clear, as in a, what data is used in the pd form, but the data used in the protocol forms is "never" inconsistent with the
     data in the gfr form. Either the data is the same, or we have cleared the pd form and from the pd form dependent data in the protocol forms.
     ==> For this method to work we need to clear the pd form, as well as the form for injection parameters, the decision info, when there is a
     change in the gfr form. Thus we must clear this on change events in the gfr form and when we clear the gfr form.
     We must also clear any data from any protocol specific functions (however, they are not implemented yet).
     We do not need to clear the actual protocol data and protocol information (thus, this should function as in commits earlier than the
     introduction of the pd form).
     Most of the above is already fixed in the code, but commented out. Search for "TODO PD" in gfr.js and commment out the 2 rows
     that clears the protocol forms.
     Note, however, that per this commit none of the called functions clears any protocol specific information under
     the "Protokoll" heading, since we have not implementet this in the code yet.
  c. A combination of a and b. In essence b but visible.
  d. Visible and with possibility to change weight and height
     In this variant we must remove the readonly attributes from the pd form weight and height.
     All code for this is already in place, and this is how it worked up until some commits ago.
     One problem with this is that the values in the pd form may not be the same as the data in the res global.
     Thus, for example, when sending data to a protocol specific function (not implemented yet) we need to also include
     all data from the pd form, since values in the pd form, which are used to calculate injection parameters etc, may
     differ from the data in the res global.

2025-11_13_2
- Some small improvements of the code
- moved out code from kontrast.html to main.js

2025-11-13
- bump av programversion: 0.5.9
- Tydligare vilken data som används i protokoll-delen. Tidigare kunde det finnas en otydlighet i detta.
  Nu framgår det tydligt.
  Sekundära ändringar till detta:
  - uppdaterad kontrast.html med ytterligare en form (pd)
  - gfr uppdaterar protokollformen ENDAST vid beräkningar av fullständigt och nytt gfr eller nytt bmi
  - uppdaterad main.js med även globalt objekt för att snabbare nå den ny pd-formen (vill, som skrivits annorstädes inte använda jquery)
  - prot.js med kod för att hantera pd-formen. Denna använder type="text" eftersom det varit trassligt med type="number", men det medför
    också att det krävs något mer kod för att validera denna form.
    I övrigt ändringar för att motsvara detta.
    Sammantaget bättre sep mellan prot.js och gfr.js. Prot.js använder inte längre alls den globala var res
  - uppdaterat style.css pga ovan

2025-11-08
- Bump av programversion: 0.5.8
- removed read only elements from tab order
- removed the gl global variable
- GFR info about patient not in small font, and text simplified

2025-11-07_2
- Bump av programversion: 0.5.7
- regression introduced below. display_version called before possibly changing version

2025-11-07
- Event Listeners för ändringar i gfr-form och protokoll-form (gfr_change, prot_change)
- Ovanstående event handlers impl. i prot.js och gfr.js
- Hanterar felaktiga värden inte bara vid form submission utan också i event handlers enligt ovan
- lag till div för kopiering. Gjordes tidigare på ett tveksamt sätt
- för komplext med required för vikt. Se mer nedan.
- gfr.js (förutom ovan):
      inget lägre required i gfr-form, därför smärre kodändringar i gfr.js
      kopieringstext gfr tydligare
      funktion enligt ovan för event listener
- prot.js:
      event handler enligt ovan
- camel case => snake case for some funcs.
- a bit better layout of func in kontrast.html


2025-11-06_2
- kontrast.html: added calc to get url parameters. If set to 1, gfr is calculated
- gfr.js: added a prog submit function to gfr.js - just does a validity check of gfr from and then uses the std submit
          In sumbmit form, resets the reset results
          use gl.calculated to see if all values in gfr-form are set
          small update of text for copying
- uppdaterat gränserna för vikt och längd baserat på tillväxtkurvor för barn. Satt gränserna med god marginal till -3SD
- varning om en gammal protokollfil används - behöver inte nödvändigtvis använda funktionaliteten

2025-11-06
- somewhat better var names and func names (a mess of camel case, pascal case and snake case)  (gfr.js, prot.js, kontrast.html)
- somewhat better layout of prot.js. No longer uses selected_prot_index. Can use a ref to the actual protocol instead. 
  Some code to own function for better sep of resp and a bit clearer code

2025-11-05_2
- fixed minor bug - did not check input element for value

2025-11-05
- jmf duBois&duBois med Haycock
- fixed clearing of gfr results always
- added text to copy with units
- simplified text to copy with link
- no text to copy visible

2025-11-04
- update gfr.js - a. because of changes in prot.js sep of resp b. updated comments
- removed old and unused div from kontrast. Changes in prot.js here
- somewhat better sep of resp in prot.js
- Better beslut
- Filter on more than one tag

2025-11-03_2
- möjlighet att filterera protokolllistan enligt tags i comments

2025-11-03
- Lagt till varning vid BMI > 40 (såsom finns i Omnivis)
- tagit bort updprot.html, det var så uselt att det inte kan rimligt användas
- Hjälpligt validerat protokollresultat (volym/inj.hast/kvot) mot Omnivis/Omniject.
  Följande värden (utelämnat värde = samma värde som närmast föregående i samma kolumn):
    Värden i protokoll jmf med omnivis för följande:
    Ålder    Längd    Vikt    Kreatinin     Prot      OK?
    60         170      75          100    Aorta      ok  kvinna
                                         Bukkärl      ok  kvinna
    40         170      75          150   buk<40      ok  kvinna
                                             buk      ok  kvinna
                        90                   buk      ok  kvinna
                                            hals      ok  kvinna
    80                                      hals      ok  man
                        60                  hals      ok  man
                                         ge l+p       ok  man
                                        epig inf      ok  man
                                   epig inf 80kv      ok  man
                                                      ok  kvinna
                        90                            ok  kvinna
               160                                    ok  kvinna
                                        buk 80kv      ok  kvinna




2025-11-02 (2)
- Bump av programversion: 0.5.7
- Added tools/updprot.html to add and remove protocols. NOT a nice ui.
- Fixed 2 bugs in tools/viewusprot.html  (array assignment is reference assignement...).
  Havent checked it thoroughly, uses [...array] which seems to be a shallow copy of the array


2025-11-02
- renamed tools/convprottocsv.html to prot2csv.html, minor changes to the file
- renamed tools/convprottoinjhastcsv.html tp prot2injhastcsv.html, minor changes to the file
- for..in to for..of everywhere gfr.js, prot.js, vol.js)
- Bug when iterating over object fixed (gfr.js). The interation was dependent on the javascript order of for (a in object), which is def.
- small changes (text) to kontrast.html
- removed ref to undersökningar in prot.js
- prot2csv.html - moved function to tools.js. Updated text.
- prot2injhastcsv.html - moved function to tools.js. Updated text.
- tools.js - added comments. funcs for generatin csv moved to file from prot2csv and prot2injhastcsv. Func to display table with prot moved to file from other file.
             func to convert prot to str (JSON.stringify not nice). Added func htmlEscape (str -> str with html entities).
             Added func rawText (str with html entities -> raw text)
- viewusprot.html - added possibility to filter table of protocols => added new funcs. Moved out func to gen table to tools.js.
- added csv2prot.html - read csv-file (as from prot2csv.html) and convert to protocol-format
- added ih2prot.html - read csv-file in "InjHast.txt"-format and conver to protocol-format. 
                       => This is probably more stable than tojson3.py, which should be considered deprecated.
- Added papaparse (csv parsing library)
- Added tools/prot2csvraw.html - like prot2csv.html but without html entities (raw text )
- Added tools/csvraw2prot.html converts raw csv data for example from prot2csvraw.html to protocol data


2025-11-01
- moved filformat.txt and info.txt to doc directory
- moved convertprottocsv.html to tools, renamed it to convprottoinjhastcsv.html, fixed it for new format of protokoll, added save button and some info
- added tools.js for tools to use with html "scripts" in the tools directory
- moved viewusprot.html to tools and updated to to reflect new layout of protocol (and where us is longer used)
- updated gitignore and moved a non versioned file to temp
- minor change to kontrast.html
- updated format for protokoll_data.js - removed id since it was not used, and added comment (comment can be used for filtering of protocol array ...)
- updated tojson3.py to reflect the stuff above
- added html script to convert protocols to csv with the same format as protocols and with html entities ( tools/convprottocsv.html )



2025-10-31
- Bump av programversion: 0.5.6
MAJOR:
1. Ändrat till att välja "protokoll" istf "undersökning"
2. Tagit bort filer sek. till ovan
3. Något ändrat format för protkoll_data.js sek till ovan (nu: array)
4. Sorterar ovanstående array innan den presenteras i select box
5. Ändrat tools/tojson3.py sek. till ovan
MINOR:
1. Uppdaterat protokoll_data.js till senaste version enl källa



2025-10-23
- Bump av programversion: 0.5.5
MAJOR:
1. Notera att Omnivis använder LM-LBM (lean body mass!!!)
   Därför ändrat standardmetod från REV-LM till LM-LBM
2. Validering av LM-LBM metod. Inget bra sätt att göra en validering mot omnivis (Omnivis har inte har något api)
   Validerat (jmf värden) enligt test-katalog mot egen kod enligt omnivis-dokument och originalart
      ( ./test/test-lm-lbm.html, ./test/lm-lbm-validation_results.csv, ./test/validate-lm-lbm.R )
   Följande testat mot omnivis, för båda könen, och stämmer med omnivis:
   ålder,langd,vikt,kreat
   20,130,30,50
   20,170,30,170
   20,170,150,90
   60,170,30,50
   60,210,70,90
   60,170,110,170
   20,130,30,170
   60,130,150,170
3. Validerat rev-lm mot omnivis för följande värden (båda könen):
   ålder,kreat
   20,50
   20,170
   20,90
   60,50
   60,90
   60,170
   20,170
   60,170
   20,190
   60,190
   80,190
4. Lagt till g jod mm vid eget angivande av volym i volymsberäkningsdelen
5. Beräkning av rGFR för barn alltid enligt den reviderade LM-metoden (enligt LT)
MINOR:
1. Added info about non validated gfr methods to func.js
2. Some new comments in func.js
3. Moved initialization of function pointer from gfr.js to javascript in kontrast.html to have everything in one place
4. Commented out possibility to use non validated gfr methods from kontrast.html
5. Some new todos and bugs in todo.txt
6. updated tools/info.txt - removed old information





2025-10-12
- Bump av programversion: 0.5.4b
- Uppdatering av gfr data medför en omräkning av protokolldata, om möjligt (rättning av bug 2025-10-11)
  Det är dock inte konsekvent, huvudsakligen för att det kan bli irriterande.
- Moved some js from kontrast to main.js

2025-10-11
- bump av programversion
- Bättre integrering mellan gfr och protokoll - ej klart (se bug)
- Möjlighet att bara räkna bmi
- Möjlighet att bara ange vikt för användning i protkoll-delen
- Flyttat upp protkolldelen till under gfr-delen
- Tagit bort en del i samband med ovan onödiga knappar
- protokoll hämtar nu vikt och agfr från gfr-delen, tex hobr() behövs därför inte längre 
- pf_form2_filled ser inte ut att behövas - har alltid samma värde som proto_ok
- warning_pkvot_change behövs inte
- fix av genbeslut
- css utflyttat till egen fil - vill inte ha så stor kontrast.html. Flytta även i kontrast.html kvarvarande js?
- i övrigt något bättre css
Bug:
- Protokoll uppdateras inte när vikt/gfr ändas


2025-10-06
- Skrivfel i en av metodenra för att beräkna gfr. Rättat.
- Småändringar

2025-10-06
Validering
( se: ./test/test-revlm.html ./test/validate-revlm.R  ./test/validate-childkreat.R )
- rev-LM validerad mot kod från egfr.se för ålder från 20 till 110 i steg om 10, kreat 10 till 300 i steg om 10, och båda könen
- rev-LM validerad mot algoritm i originalartikel (som ovan)
- alg för reviderat barn-kreat validerad mot kod från egfr för ålder från 2 till 17 år, kreat 10 till 300 i steg om 10, och båda könen
- alg för reviderat barn-kreat validerad mot algoritm i läkartidningen (som ovan)




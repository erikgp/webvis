<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<link href="style.css" rel="stylesheet"/>

<script src="protokoll_data.js" defer="defer"></script>
<script src="main.js" defer="defer"></script>
<script src="funcs.js" defer="defer"></script>
<script src="gfr.js" defer="defer"></script>
<script src="vol.js" defer="defer"></script>
<script src="prot.js" defer="defer"></script>
<script>
/*
    Generic startup code
*/

/*
document.addEventListener("DOMContentLoaded", function(event){
    // your code here
    initialize();
});
*/

/*
 * This is called from body onload, and us used to initialize the page
 */
function initialize() {
    getElmts();
    prot_ini_select();
    getParameters();
    displayVersions();
    document.getElementById("gfr_age").focus();
}


/*
 * Display version of code
 */
function displayVersions() {
    let u = document.getElementById("version");
    let infostr = "Programversion: " + prog_version + "&nbsp;&nbsp;&nbsp;Protokollversion: " + protokoll_data_version + "<br/><br/>";  
    infostr +=    gfr_metod_info + "<br/>";

    u.innerHTML = infostr;
}


/*
 * Function to populate gfr data form input elements with
 * data from get parameters submitted to the page, if
 * any...
 *
 * Unset get parameters will be null i url.searchParams.get. parseInt(null) is NaN
 *
 * This could be done more nincely by using the input element id:s etc.
 */
function getParameters() {
    let url = new URL(location.href);
    let age = parseInt(url.searchParams.get("age"));
    let langd = parseInt(url.searchParams.get("langd"));
    let vikt = parseInt(url.searchParams.get("vikt"));
    let kreat = parseInt(url.searchParams.get("kreat"));
    let sex = parseInt(url.searchParams.get("sex"));

    fgfr.gfr_age.value = isNaN(age) ? "" : age;
    fgfr.gfr_height.value = isNaN(langd) ? "" : langd;
    fgfr.gfr_weight.value = isNaN(vikt) ? "" : vikt;
    fgfr.gfr_kreat.value = isNaN(vikt) ? "" : kreat;

    // fix sex
    if ( ! isNaN(sex) && (sex == 0 || sex == 1) ) {
        let s = document.getElementsByName("gfr_sexbtn");
        s[sex].checked = true;
    }


    // default method
    // --------------
    // Omnivis använder Lund-Malmö LBM (lean body mass) !!! Ändrat till denna metod.
    // gfr_metod_info = "Estimerat relativt och absolut GFR baserat på kreatinin och estimerat rGFR enl. den reviderade Lund-Malmö-metoden.";
    gfr_metod_info = "Estimerat relativt och absolut GFR baserat på kreatinin och estimerat aGFR enl. Lund-Malmö med lean body mass.";

    /*
     * Function "pointer" for calc gfr from kreat and data
     * All functions to calculate gfr from kreat have the same interface and returns the same values
     * Omivis uses Lund-Malmö lean body mass as std
     */
    //  kreat_gfr_func = wr_rgfr_revlm;
     kreat_gfr_func = wr_agfr_lm;


    let method = url.searchParams.get("method");
    if (method != null) {
        switch (method) {
            /*
            // Not validated
            case "cock":   // :-D
                 kreat_gfr_func = wr_agfr_cockgault;
                 gfr_metod_info = "Estimerat relativt och absolut GFR baserat på kreatinin och estimerat aGFR enl. Cockcroft Gault.";
                 break;
             */
            case "lm-lbm":
                 kreat_gfr_func = wr_agfr_lm;
                 gfr_metod_info = "Estimerat relativt och absolut GFR baserat på kreatinin och estimerat aGFR enl. Lund-Malmö med lean body mass.";
                 break;
            case "lm-rev":
                 kreat_gfr_func = wr_rgfr_revlm;
                 gfr_metod_info = "Estimerat relativt och absolut GFR baserat på kreatinin och estimerat rGFR enl. den reviderade Lund-Malmö-metoden.";
                 break;
            /*
            // Not validated
            case "mdrd":
                kreat_gfr_func = wr_rgfr_mdrd;
                 gfr_metod_info = "Estimerat relativt och absolut GFR baserat på kreatinin och estimerat rGFR enl. MDRD-IDMS.";
                 break;
            // Not validated
            case "ckd":
                kreat_gfr_func = wr_rgfr_ckd_kreat;
                 gfr_metod_info = "Estimerat relativt och absolut GFR baserat på kreatinin och estimerat rGFR enl. CKD-EPI_KREA.";
                 break;
            */
        }
    } 
}

</script>

</head>
<body onload="initialize()">

<!-- rGFR, aGFR och BMI -->
<div>
    <h3>rGFR och aGFR estimerat från Kreatinin-värde för vuxna 18 år och äldre.</h3>
</div>
<div class="info">
<span id="version"></span>
Programmet kan med försiktighet användas för att beräkna relativt GFR för barn &ge; 2 år tillsammans med den reviderade LM-metoden.<br/>
Notera att vissa metoder primärt ger ett estimat av aGFR, andra av rGFR.<br/>
Omräkning sker via uppskattad kroppsyta enl. Dubois och Dubois, vilket introducerar ytterligare viss osäkerhet.<br/>
</div>
<div class="parent">
<div class="c1">
    <form id="gfr_form" action="javascript:gfr_submit_gfr_form()">
    <table>
        <tr>
            <td><label>Ålder (år)</label></td>
            <td><input id="gfr_age" type="number" min="2" max="110" value="" onchange="gfr_resetgfrdata();"/></td>      <!-- TODO: Min AGE? -->
        </tr>
        <tr>
            <td><label>Längd (cm)</label></td>
            <td><input id="gfr_height" type="number" min="75" max="215" value="" onchange="gfr_resetgfrdata();"/></td>
        </tr>
        <tr>
            <td><label>Vikt (kg)</label></td>
            <td><input id="gfr_weight" type="number" min="10" max="250" value="" onchange="gfr_resetgfrdata2();" required="true"/></td>
        </tr>
        <tr>
            <td><label>Kreatinin (μmol/L)</label></td>
            <td><input id="gfr_kreat" type="number" value="" min="10" max="800" onchange="gfr_resetgfrdata();"/></td>  <!-- TODO: Min and max values  -->
        </tr>
        <tr>
            <td><label>Kön</label></td>
            <td><input id="gfr_sex" name="gfr_sexbtn" type="radio" value="0" checked  onchange="gfr_resetgfrdata();"/><label>kvinna</label>       <!-- TODO: Min and max values  -->
                <input id="gfr_sex" name="gfr_sexbtn" type="radio" value="1"  onchange="gfr_resetgfrdata();"/><label>man</label></td>  <!-- TODO: Min and max values  -->
        </tr>
        <tr>
            <td/>
            <td><input type="submit" value="Beräkna"/>&nbsp;<input type="button" value="Rensa" onclick="gfr_resetgfrdata(true);"/></td>
        </tr>
    </table>
    </form>
</div>
<div id="res1" class="r"></div>
</div>

<!-- Protokoll -->
<hr/>
<div>
<h3>Protokoll</h3>
</div>

<div class="parent">
    <div>
        <form action="#">
            <select id="pf_proto" name="pf_proto" size="20" onchange="prot_proto_sel(this);">
            </select>
        </form>
    </div>
    <div class="r2">
        <h4>Protokollparametrar</h4>
        <form id="pf_form" action="javascript:prot_protokollber();">
            <table>
                <tr><td><label>Dos: </label></td><td><input id="pf_dos" name="pf_dos" type="number" min="0" max="999" required="true" onchange="prot_reset_pf_forms();"/> mg jod/kg</td></tr>
            <tr><td><label>Koncentration: </label></td><td><input id="pf_konc" name="pf_konc" type="number" min="100" max="800" required="true" onchange="prot_reset_pf_forms();"/> mg jod/ml</td></tr>
            <tr><td><label>Injektionstid: </label></td><td><input id="pf_tid" name="pf_tid" type="number" min="1" max="240" required="true" onchange="prot_reset_pf_forms();"/> sekunder</td></tr>
            <tr><td><label>Doshastighet: </label></td><td><input id="pf_dosh" name="pf_dosh" type="number" min="1" max="240" step="0.1" readonly="true"/> mg jod/(kg*s)</td></tr>
            <tr><td><label>Maxvikt: </label></td><td><input id="pf_maxvikt" name="pf_maxvikt" type="number" min="1" max="150" required="true" onchange="prot_reset_pf_forms();"/> kg
            <label>motsvarar: </label><input id="pf_maxvol" name="pf_maxvol" type="number" min="1" max="150" step="0.1" readonly="true" onchange="prot_reset_pf_forms();"/> ml</td></tr>
            <tr><td></td><td><input type="submit" value="Beräkna" onchange="prot_reset_pf_forms();"/></td></tr>
            </table>
        </form>
        <h4>Injektionsparametrar</h4>
        <form id="pf_form2" action="javascript:prot_kvottodos();">
        <table>
        <tr><td><label>Volym: </label></td><td><input id="pf_pvol" name="pf_pvol" type="number" min="1" max="500" step="0.1" readonly="true"/> ml (avrundat till närmaste ml)</td></tr>
        <tr><td><label>Injektionshastighet: </label></td><td><input id="pf_pinjh" name="pf_pinjh" type="number" min="0" max="6" step="0.1" readonly="true"/> ml/s</td></tr>
        <tr><td><label>Dos: </label></td><td><input id="pf_pdos" name="pf_pdos" type="number" min="0" max="200" step="0.1" readonly="true"/> g jod</td></tr>
        <!-- -<tr><td><label>Gram jod/GFR-kvot: </label></td><td><input id="pf_pkvot" name="pf_pkvot" type="number" min="0.0" max="200.0" step="0.01" onchange="warning_pkvot_changed();"/> -->
        <tr><td><label>Gram jod/GFR-kvot: </label></td><td><input id="pf_pkvot" name="pf_pkvot" type="number" min="0.0" max="200.0" step="0.01" onchange="prot_kvottodos();"/>
           <div id="pkvot_changed" style="display: inline;"></div></td></tr>
        <tr><td></td><td><input type="submit" value="Kvot till dos"/></td></tr>
        </table>
        </form>
    </div>
    <div class="r2">
        <h4>Protokollinformation</h4>
        <div id="p_info"></div>
    </div>
</div>

<div>
    <input type="button" value="Rensa" onclick="prot_rensa_allt();">
    <input type="button" value="Beslut" onclick="prot_genbeslut();">
    <div id="beslut"></div>
</div>



<!-- Volym och kvoter av kontrast -->
<hr/>
<div>
<h3>Volyms- och kvot-beräkning</h3>
<!--
Volym kontrastmedel av viss koncentration som motsvarar angiven "kvot",<br/>
vilken kvot som fås av en viss volym kontrastmedel av angiven koncentration, samt vilken volym kontrastmedel<br/>
av en given koncentration som motsvarar angiven kvot.<br/>
Endast aGFR måste anges, men då fås inte all information.<br/><br/>
-->
<form action="javascript:volymer();">
    <label>Absolut GFR (ml/min): </label><input type="number" id="vol_gfr" min="1" max="600" required="true"/> <!-- TODO: min och max. No std value -->
    <label>Kvot: </label><input type="number" id="vol_kvot" min="0.01" max="4" value="1" step="any" required="true" /><br/> <!-- TODO: min och max. No std value -->
    <label>Kontrasmedelsvolym (ml): </label><input type="number" id="vol_vol" min="0" max="300"/> <!-- TODO: min och max -->
    <label>Koncentration (mg jod/ml): </label><input type="number" id="vol_konc" min="100" max="500" value="350"/><br/> <!-- TODO: min och max -->
    <input type="submit" value="Beräkna"/>
</form>
<div id="res2">
</div>
</div>

<div id="footer">
    (c) och utvecklat av Erik Persson, överläkare, Verksamhetsområde Diagnostik, Centralsjukhuset Kristianstad.
</div>

</body>
</html>

